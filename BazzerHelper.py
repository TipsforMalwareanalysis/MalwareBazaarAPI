import requests
import os
import yaml
from tqdm import tqdm

class BazzarHelper():
    def __init__(self):
        self.apikey = ""
        self.url = "https://mb-api.abuse.ch/api/v1/"

        try:
            with open('config.yaml') as f:
                cfg = yaml.load(f, Loader=yaml.FullLoader)
                self.api = cfg['config']['API']
        except Exception:
            print("API키를 확인해주세요(config.yaml)")

    def querySignature(self, signature):
        """
        시그니처기반 악성코드 검색
        :param signature: 악성코드 시그니처
        :return:
        """
        data = {
            "query": "get_siginfo",
            "signature": signature
        }
        return requests.post(self.url, data=data, timeout=15)

    def downloadSample(self, malwareHash, saveDirpath="downloads"):
        """
        악성코드 다운로드
        :param malwareHash: 악성코드 해시(sha256)
        :return:
        """
        headers = {'API-KEY': self.apikey}
        data = {
            'query': 'get_file',
            'sha256_hash': malwareHash
        }
        response = requests.post('https://mb-api.abuse.ch/api/v1/', data=data, timeout=15, headers=headers,
                                 allow_redirects=True)

        # save the malware(.zip)
        download_path = os.path.join(saveDirpath, malwareHash)
        open(download_path + '.zip', 'wb').write(response.content)